rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regras para a coleção 'users'
    match /users/{userId} {
      allow create: if request.auth != null;
      // Permite que um usuário obtenha seu próprio documento
      allow get: if request.auth != null && request.auth.uid == userId;
      // Permite que usuários atualizem seus próprios dados
      allow update: if request.auth != null && request.auth.uid == userId;
      // Permite que usuários deletem seus próprios dados
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Regra para permitir listagem de usuários para administradores e clientes
    // Clientes podem buscar motoristas online, administradores têm acesso total
    match /users {
      allow list: if request.auth != null;
    }
    
    // Regras especiais para administradores - acesso total aos usuários
    match /users/{userId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'transactions'
    match /transactions/{transactionId} {
      // O motorista pode ler/atualizar/deletar suas transações.
      // O cliente pode ler/atualizar/deletar as transações que ele criou.
      allow read, update, delete: if request.auth != null && 
                                      (request.auth.uid == resource.data.userId || 
                                       (resource.data.clientId != null && request.auth.uid == resource.data.clientId));
      // Permite que motoristas e clientes criem transações.
      allow create: if request.auth != null;
    }
    
    // Regra para permitir queries (list) na coleção transactions
    match /transactions {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total a todas as transações
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }
    
    // Regras para a coleção 'workShifts'
    match /workShifts/{shiftId} {
      // Usuários podem gerenciar suas próprias jornadas
      allow read, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create, update: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Regra para permitir queries (list) na coleção workShifts
    match /workShifts {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total às jornadas
    match /workShifts/{shiftId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // REGRAS SEGURAS E FINAIS para a coleção 'appointments'
    match /appointments/{appointmentId} {
      // --- REGRAS DE LEITURA ---
      // Permite obter um documento específico se o usuário for o dono.
      allow get: if request.auth != null && request.auth.uid == resource.data.userId;
      // Permite listar (fazer query) se o usuário estiver autenticado.
      // A segurança da consulta é reforçada pelo código da aplicação.
      allow list: if request.auth != null;

      // --- REGRAS DE ESCRITA ---
      // Permite criar um novo agendamento se o usuário estiver autenticado e for o dono.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Permite atualizar um agendamento se o usuário for o dono.
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Permite apagar um agendamento se o usuário for o dono.
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Regra especial para administradores - acesso total aos agendamentos
    match /appointments/{appointmentId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'configurations'
    match /configurations/{userId} {
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
    }

    // Regras para a coleção 'vehicles'
    match /vehicles/{vehicleId} {
      // Usuários podem gerenciar seus próprios veículos
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Regra para permitir queries (list) na coleção vehicles
    match /vehicles {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total aos veículos
    match /vehicles/{vehicleId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'maintenance'
    match /maintenance/{maintenanceId} {
      // Usuários podem gerenciar suas próprias manutenções
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Regra para permitir queries (list) na coleção maintenance
    match /maintenance {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total às manutenções
    match /maintenance/{maintenanceId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'fuel'
    match /fuel/{fuelId} {
      // Usuários podem gerenciar seus próprios combustíveis
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Regra para permitir queries (list) na coleção fuel
    match /fuel {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total aos combustíveis
    match /fuel/{fuelId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para notificações
    match /notifications/{notificationId} {
      // Usuários podem gerenciar suas próprias notificações
      allow read, write, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Regra para permitir queries (list) na coleção notifications
    match /notifications {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total às notificações
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para configurações de notificação
    match /notificationSettings/{userId} {
      // Usuários podem gerenciar suas próprias configurações
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Regra especial para administradores - acesso total às configurações
    match /notificationSettings/{userId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para tokens FCM
    match /fcmTokens/{userId} {
      // Usuários podem gerenciar seus próprios tokens
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Regra especial para administradores - acesso total aos tokens
    match /fcmTokens/{userId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'recipients'
    match /recipients/{recipientId} {
      // Usuários podem gerenciar seus próprios destinatários
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }
    
    // Regra para permitir queries (list) na coleção recipients
    match /recipients {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total aos destinatários
    match /recipients/{recipientId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'plans'
    match /plans/{planId} {
      // Todos os usuários autenticados podem ler os planos
      allow read: if request.auth != null;
      // Apenas administradores podem criar, atualizar ou deletar planos
      allow create, update, delete: if request.auth != null && 
                                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }
    
    // Regra para permitir listagem de planos
    match /plans {
      allow list: if request.auth != null;
    }

    // Regras para a coleção 'subscriptions'
    match /subscriptions/{subscriptionId} {
      // Usuários podem ler apenas suas próprias assinaturas
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Usuários podem criar suas próprias assinaturas
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Usuários podem atualizar suas próprias assinaturas
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Apenas administradores podem deletar assinaturas
      allow delete: if request.auth != null && 
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }
    
    // Regra para permitir listagem de assinaturas
    match /subscriptions {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total às assinaturas
    match /subscriptions/{subscriptionId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'usage'
    match /usage/{usageId} {
      // Usuários podem ler apenas seus próprios dados de uso
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Usuários podem criar seus próprios dados de uso
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Usuários podem atualizar seus próprios dados de uso
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Apenas administradores podem deletar dados de uso
      allow delete: if request.auth != null && 
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }
    
    // Regra para permitir listagem de dados de uso
    match /usage {
      allow list: if request.auth != null;
    }
    
    // Regra especial para administradores - acesso total aos dados de uso
    match /usage/{usageId} {
      allow read, write: if request.auth != null && 
                            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

  }
}
