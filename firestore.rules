rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função auxiliar para verificar se o usuário é administrador
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Regras para a coleção 'users'
    match /users/{userId} {
      allow create: if request.auth != null;
      // Permite que um usuário obtenha seu próprio documento ou administradores vejam qualquer usuário
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Permite que usuários autenticados listem (query) outros usuários.
      // A consulta no lado do cliente deve ser segura e filtrar adequadamente (ex: por userType).
      allow list: if request.auth != null;
      // Permite que usuários atualizem seus próprios dados ou administradores atualizem qualquer usuário
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Permite que usuários deletem seus próprios dados ou administradores deletem qualquer usuário
      allow delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Regras para a coleção 'transactions'
    match /transactions/{transactionId} {
      // O motorista pode ler/atualizar/deletar suas transações.
      // O cliente pode ler/atualizar/deletar as transações que ele criou.
      // Administradores podem ler/atualizar/deletar qualquer transação.
      allow read, update, delete: if request.auth != null && 
                                      (request.auth.uid == resource.data.userId || 
                                       (resource.data.clientId != null && request.auth.uid == resource.data.clientId) ||
                                       isAdmin());
      // Permite que motoristas, clientes e administradores criem transações.
      allow create: if request.auth != null;
    }
    
    // Regra para permitir queries (list) na coleção transactions
    match /transactions {
      allow list: if request.auth != null;
    }
    
    // Regras para a coleção 'workShifts'
    match /workShifts/{shiftId} {
      // Usuários podem gerenciar suas próprias jornadas ou administradores podem gerenciar qualquer jornada
      allow read, delete: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      allow create, update: if request.auth != null && (request.auth.uid == request.resource.data.userId || isAdmin());
    }
    
    // Regra para permitir queries (list) na coleção workShifts
    match /workShifts {
      allow list: if request.auth != null;
    }

    // REGRAS SEGURAS E FINAIS para a coleção 'appointments'
    match /appointments/{appointmentId} {
      // --- REGRAS DE LEITURA ---
      // Permite obter um documento específico se o usuário for o dono ou se for administrador.
      allow get: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      // Permite listar (fazer query) se o usuário estiver autenticado.
      // A segurança da consulta é reforçada pelo código da aplicação.
      allow list: if request.auth != null;

      // --- REGRAS DE ESCRITA ---
      // Permite criar um novo agendamento se o usuário estiver autenticado e for o dono.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Permite atualizar um agendamento se o usuário for o dono ou se for administrador.
      allow update: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      // Permite apagar um agendamento se o usuário for o dono ou se for administrador.
      allow delete: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
    }

    // Regras para a coleção 'configurations'
    match /configurations/{userId} {
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
    }

    // Regras para a coleção 'vehicles'
    match /vehicles/{vehicleId} {
      // Usuários podem gerenciar seus próprios veículos ou administradores podem gerenciar qualquer veículo
      allow read, write: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if request.auth != null && (request.auth.uid == request.resource.data.userId || isAdmin());
    }
    
    // Regra para permitir queries (list) na coleção vehicles
    match /vehicles {
      allow list: if request.auth != null;
    }

    // Regras para a coleção 'maintenance'
    match /maintenance/{maintenanceId} {
      // Usuários podem gerenciar suas próprias manutenções ou administradores podem gerenciar qualquer manutenção
      allow read, write: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if request.auth != null && (request.auth.uid == request.resource.data.userId || isAdmin());
    }
    
    // Regra para permitir queries (list) na coleção maintenance
    match /maintenance {
      allow list: if request.auth != null;
    }

    // Regras para a coleção 'fuel'
    match /fuel/{fuelId} {
      // Usuários podem gerenciar seus próprios combustíveis ou administradores podem gerenciar qualquer combustível
      allow read, write: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if request.auth != null && (request.auth.uid == request.resource.data.userId || isAdmin());
    }
    
    // Regra para permitir queries (list) na coleção fuel
    match /fuel {
      allow list: if request.auth != null;
    }

    // Regras para notificações
    match /notifications/{notificationId} {
      // Usuários podem gerenciar suas próprias notificações ou administradores podem gerenciar qualquer notificação
      allow read, write: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if request.auth != null && (request.auth.uid == request.resource.data.userId || isAdmin());
    }
    
    // Regra para permitir queries (list) na coleção notifications
    match /notifications {
      allow list: if request.auth != null;
    }

    // Regras para configurações de notificação
    match /notificationSettings/{userId} {
      // Usuários podem gerenciar suas próprias configurações ou administradores podem gerenciar qualquer configuração
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Regras para tokens FCM
    match /fcmTokens/{userId} {
      // Usuários podem gerenciar seus próprios tokens ou administradores podem gerenciar qualquer token
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Regras para a coleção 'recipients'
    match /recipients/{recipientId} {
      // Usuários podem gerenciar seus próprios destinatários ou administradores podem gerenciar qualquer destinatário
      allow read, write: if request.auth != null && (request.auth.uid == resource.data.userId || isAdmin());
      allow create: if request.auth != null && (request.auth.uid == request.resource.data.userId || isAdmin());
    }
    
    // Regra para permitir queries (list) na coleção recipients
    match /recipients {
      allow list: if request.auth != null;
    }
  }
}
